<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SLAYDLE</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>

/* all colors hardcoded below - no CSS variables to avoid mobile rendering issues */

- { box-sizing: border-box; margin: 0; padding: 0; }

html {
background: #030f06;
}

body {
background: #030f06;
color: #00ff41;
font-family: ‚ÄòShare Tech Mono‚Äô, monospace;
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
overflow-x: hidden;
}

/* Scanline overlay */
body::before {
content: ‚Äò‚Äô;
position: fixed;
top: 0; left: 0; right: 0; bottom: 0;
background: repeating-linear-gradient(
0deg,
transparent,
transparent 2px,
rgba(0,0,0,0.08) 2px,
rgba(0,0,0,0.08) 4px
);
pointer-events: none;
z-index: 999;
}

/* CRT flicker */
@keyframes flicker {
0%, 100% { opacity: 1; }
92% { opacity: 1; }
93% { opacity: 0.97; }
94% { opacity: 1; }
}
body { animation: flicker 8s infinite; }

#app {
width: 100%;
max-width: 480px;
padding: 0 12px 80px;
display: flex;
flex-direction: column;
align-items: center;
}

/* HEADER */
#header {
width: 100%;
text-align: center;
padding: 18px 0 8px;
border-bottom: 1px solid #00cc33;
margin-bottom: 12px;
}

#title {
font-family: ‚ÄòPress Start 2P‚Äô, monospace;
font-size: 22px;
color: #00ff41;
text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41;
letter-spacing: 4px;
}

#subtitle {
font-size: 10px;
color: #00cc33;
margin-top: 4px;
letter-spacing: 2px;
}

/* GOBLIN CARD */
#goblin-card {
width: 100%;
border: 1px solid #00cc33;
padding: 12px;
margin-bottom: 10px;
background: #001a08;
position: relative;
}

#goblin-card::before {
content: ‚Äò[ ENEMY ]‚Äô;
position: absolute;
top: -9px;
left: 10px;
background: #030f06;
padding: 0 6px;
font-size: 10px;
color: #00cc33;
letter-spacing: 2px;
}

#goblin-name {
font-family: ‚ÄòPress Start 2P‚Äô, monospace;
font-size: 13px;
color: #ffff00;
text-shadow: 0 0 8px #ffff00;
text-align: center;
margin-bottom: 10px;
line-height: 1.6;
}

.ascii-goblin {
font-family: ‚ÄòShare Tech Mono‚Äô, monospace;
font-size: 11px;
line-height: 1.4;
color: #00cc33;
text-align: center;
white-space: pre;
margin-bottom: 10px;
}

/* HP BARS */
.hp-section {
display: flex;
flex-direction: column;
gap: 6px;
width: 100%;
}

.hp-row {
display: flex;
align-items: center;
gap: 8px;
font-size: 11px;
}

.hp-label {
width: 70px;
color: #00cc33;
letter-spacing: 1px;
flex-shrink: 0;
}

.hp-bar {
flex: 1;
height: 12px;
background: #0a2a12;
border: 1px solid #00cc33;
position: relative;
overflow: hidden;
}

.hp-fill {
height: 100%;
transition: width 0.4s ease;
position: relative;
}

.hp-fill.player { background: #00ff41; }
.hp-fill.goblin { background: #ff5555; }

.hp-fill::after {
content: ‚Äò‚Äô;
position: absolute;
top: 0; left: 0; right: 0; bottom: 0;
background: repeating-linear-gradient(
90deg,
transparent,
transparent 6px,
rgba(0,0,0,0.2) 6px,
rgba(0,0,0,0.2) 7px
);
}

.hp-number {
width: 36px;
text-align: right;
font-size: 11px;
flex-shrink: 0;
}

.hp-number.player { color: #00ff41; }
.hp-number.goblin { color: #ff5555; }

/* BATTLE LOG */
#battle-log-container {
width: 100%;
border: 1px solid #00cc33;
margin-bottom: 10px;
background: #001a08;
position: relative;
}

#battle-log-container::before {
content: ‚Äò[ BATTLE LOG ]‚Äô;
position: absolute;
top: -9px;
left: 10px;
background: #030f06;
padding: 0 6px;
font-size: 10px;
color: #00cc33;
letter-spacing: 2px;
}

#battle-log {
max-height: 220px;
overflow-y: auto;
padding: 14px 10px 8px;
font-size: 11px;
line-height: 1.7;
scroll-behavior: smooth;
}

#battle-log::-webkit-scrollbar { width: 4px; }
#battle-log::-webkit-scrollbar-track { background: var(‚Äìdarker-green); }
#battle-log::-webkit-scrollbar-thumb { background: var(‚Äìdim-green); }

.log-entry { margin-bottom: 8px; }

.log-turn {
color: #00cc33;
font-size: 10px;
letter-spacing: 1px;
}

.log-attack { color: #00ffff; }
.log-very-effective { color: #ffff00; text-shadow: 0 0 6px #ffff00; }
.log-effective { color: #00ff41; }
.log-ineffective { color: #667766; }
.log-goblin-hit { color: #ff5555; }
.log-hint { color: #dd88ff; }
.log-system { color: #00cc33; font-style: italic; }

.log-empty {
color: #336633;
font-size: 11px;
padding: 8px 0;
text-align: center;
}

/* ATTACK PANEL */
#attack-panel {
width: 100%;
border: 1px solid #00cc33;
padding: 12px;
margin-bottom: 10px;
background: #001a08;
position: relative;
}

#attack-panel::before {
content: ‚Äò[ ATTACK ]‚Äô;
position: absolute;
top: -9px;
left: 10px;
background: #030f06;
padding: 0 6px;
font-size: 10px;
color: #00cc33;
letter-spacing: 2px;
}

.attack-group {
margin-bottom: 12px;
}

.attack-group-label {
font-size: 10px;
color: #00cc33;
letter-spacing: 2px;
margin-bottom: 8px;
}

.attack-options {
display: flex;
gap: 6px;
flex-wrap: wrap;
}

.attack-btn {
flex: 1;
min-width: 70px;
padding: 8px 4px;
background: #0a2a12;
border: 2px solid #00ff41;
color: #00ff41;
font-family: ‚ÄòShare Tech Mono‚Äô, monospace;
font-size: 11px;
cursor: pointer;
text-align: center;
letter-spacing: 1px;
transition: all 0.1s;
position: relative;
outline: none;
-webkit-tap-highlight-color: transparent;
border-radius: 0;
-webkit-appearance: none;
appearance: none;
}

.attack-btn:hover {
border-color: #00ff41;
background: #0f3a1a;
}

.attack-btn.selected {
background: #00ff41 !important;
color: #000000 !important;
border-color: #00ff41 !important;
box-shadow: 0 0 14px #00ff41, inset 0 0 4px rgba(255,255,255,0.2) !important;
font-weight: bold;
}

.attack-btn .btn-icon {
display: block;
font-size: 18px;
margin-bottom: 4px;
}

.attack-btn .btn-label {
display: block;
font-size: 9px;
letter-spacing: 1px;
color: inherit;
}

/* Element colors when selected */
.attack-btn.selected.fire    { background: #ff8800 !important; border-color: #ff8800 !important; box-shadow: 0 0 14px #ff8800 !important; color: #000 !important; }
.attack-btn.selected.ice     { background: #00ffff !important; border-color: #00ffff !important; box-shadow: 0 0 14px #00ffff !important; color: #000 !important; }
.attack-btn.selected.electric{ background: #ffff00 !important; border-color: #ffff00 !important; box-shadow: 0 0 14px #ffff00 !important; color: #000 !important; }
.attack-btn.selected.physical{ background: #ffffff !important; border-color: #ffffff !important; box-shadow: 0 0 14px #ffffff !important; color: #000 !important; }

/* STRIKE button */
#strike-btn {
width: 100%;
padding: 14px;
background: transparent;
border: 2px solid #00ff41;
color: #00ff41;
font-family: ‚ÄòPress Start 2P‚Äô, monospace;
font-size: 13px;
cursor: pointer;
letter-spacing: 3px;
text-shadow: 0 0 8px #00ff41;
box-shadow: 0 0 8px rgba(0,255,65,0.2);
transition: all 0.15s;
outline: none;
-webkit-tap-highlight-color: transparent;
-webkit-appearance: none;
}

#strike-btn:hover:not(:disabled) {
background: #00ff41;
color: #000000;
box-shadow: 0 0 20px #00ff41;
}

#strike-btn:disabled {
opacity: 0.3;
cursor: not-allowed;
border-color: #225522;
color: #225522;
box-shadow: none;
text-shadow: none;
}

/* CRYSTAL BALL */
#crystal-ball-btn {
width: 100%;
padding: 10px;
background: transparent;
border: 1px solid #cc44ff;
color: #cc44ff;
font-family: ‚ÄòShare Tech Mono‚Äô, monospace;
font-size: 11px;
cursor: pointer;
letter-spacing: 2px;
margin-top: 8px;
transition: all 0.15s;
outline: none;
-webkit-tap-highlight-color: transparent;
-webkit-appearance: none;
}

#crystal-ball-btn:hover:not(:disabled) {
background: rgba(204, 68, 255, 0.15);
box-shadow: 0 0 10px rgba(204, 68, 255, 0.4);
}

#crystal-ball-btn:disabled {
opacity: 0.25;
cursor: not-allowed;
}

/* GAME OVER / WIN */
#result-screen {
width: 100%;
border: 2px solid #00ff41;
padding: 20px;
text-align: center;
background: #0a2a12;
display: none;
flex-direction: column;
align-items: center;
gap: 12px;
margin-bottom: 10px;
}

#result-screen.show { display: flex; }
#result-screen.defeat { border-color: #ff5555; }

#result-title {
font-family: ‚ÄòPress Start 2P‚Äô, monospace;
font-size: 14px;
line-height: 1.8;
}

#result-title.victory { color: #ffff00; text-shadow: 0 0 12px #ffff00; }
#result-title.defeat  { color: #ff5555; text-shadow: 0 0 12px #ff5555; }

#result-message {
font-size: 12px;
line-height: 1.9;
color: #00ff41;
}

#scorecard-text {
font-size: 12px;
line-height: 1.9;
color: #00ff41;
background: #030f06;
border: 1px solid #00cc33;
padding: 12px;
width: 100%;
text-align: left;
white-space: pre-wrap;
word-break: break-word;
}

#copy-btn {
padding: 12px 24px;
background: transparent;
border: 2px solid #00ffff;
color: #00ffff;
font-family: ‚ÄòShare Tech Mono‚Äô, monospace;
font-size: 12px;
cursor: pointer;
letter-spacing: 2px;
transition: all 0.15s;
outline: none;
-webkit-appearance: none;
}

#copy-btn:hover {
background: rgba(0,255,255,0.15);
box-shadow: 0 0 10px rgba(0,255,255,0.5);
}

/* Animations */
@keyframes shake {
0%, 100% { transform: translateX(0); }
20% { transform: translateX(-4px); }
40% { transform: translateX(4px); }
60% { transform: translateX(-4px); }
80% { transform: translateX(4px); }
}

@keyframes pulse-green {
0%, 100% { text-shadow: 0 0 8px var(‚Äìgreen); }
50% { text-shadow: 0 0 20px var(‚Äìgreen), 0 0 40px var(‚Äìgreen); }
}

@keyframes typewriter {
from { opacity: 0; transform: translateY(4px); }
to { opacity: 1; transform: translateY(0); }
}

.log-entry { animation: typewriter 0.2s ease forwards; }

.shake { animation: shake 0.4s ease; }

#date-display {
font-size: 9px;
color: #33aa55;
letter-spacing: 2px;
margin-top: 4px;
}

#disclaimer {
font-size: 9px;
color: #336633;
letter-spacing: 1px;
margin-top: 20px;
margin-bottom: 10px;
text-align: center;
width: 100%;
}
</style>

</head>
<body>
<div id="app">

  <div id="header">
    <div id="title">SLAYDLE</div>
    <div id="subtitle">DAILY GOBLIN BATTLE</div>
    <div id="date-display"></div>
  </div>

  <div id="goblin-card">
    <div id="goblin-name">???</div>
    <div class="ascii-goblin" id="goblin-art">
    .-"-.
   /  ,  \
  | (o)(o)|
  |  \__/ |
   \ /\/\ /
    |    |
   /|    |\
  /_|____|_\</div>
    <div class="hp-section">
      <div class="hp-row">
        <span class="hp-label">GOBLIN HP</span>
        <div class="hp-bar"><div class="hp-fill goblin" id="goblin-hp-bar" style="width:100%"></div></div>
        <span class="hp-number goblin" id="goblin-hp-num">5/5</span>
      </div>
      <div class="hp-row">
        <span class="hp-label">YOUR HP</span>
        <div class="hp-bar"><div class="hp-fill player" id="player-hp-bar" style="width:100%"></div></div>
        <span class="hp-number player" id="player-hp-num">5/5</span>
      </div>
    </div>
  </div>

  <div id="battle-log-container">
    <div id="battle-log">
      <div class="log-empty">[ Awaiting your move, adventurer... ]</div>
    </div>
  </div>

  <div id="attack-panel">
    <div class="attack-group">
      <div class="attack-group-label">WEAPON</div>
      <div class="attack-options" id="weapon-options">
        <button class="attack-btn" data-type="weapon" data-value="bow">
          <span class="btn-icon">üèπ</span>
          <span class="btn-label">BOW</span>
        </button>
        <button class="attack-btn" data-type="weapon" data-value="sword">
          <span class="btn-icon">‚öîÔ∏è</span>
          <span class="btn-label">SWORD</span>
        </button>
        <button class="attack-btn" data-type="weapon" data-value="club">
          <span class="btn-icon">ü™ì</span>
          <span class="btn-label">CLUB</span>
        </button>
      </div>
    </div>
    <div class="attack-group">
      <div class="attack-group-label">ELEMENT</div>
      <div class="attack-options" id="element-options">
        <button class="attack-btn fire" data-type="element" data-value="fire">
          <span class="btn-icon">üî•</span>
          <span class="btn-label">FIRE</span>
        </button>
        <button class="attack-btn ice" data-type="element" data-value="ice">
          <span class="btn-icon">‚ùÑÔ∏è</span>
          <span class="btn-label">ICE</span>
        </button>
        <button class="attack-btn electric" data-type="element" data-value="electric">
          <span class="btn-icon">‚ö°</span>
          <span class="btn-label">ELECTRIC</span>
        </button>
        <button class="attack-btn physical" data-type="element" data-value="physical">
          <span class="btn-icon">üí™</span>
          <span class="btn-label">PHYSICAL</span>
        </button>
      </div>
    </div>
    <button id="strike-btn" disabled>‚öî STRIKE ‚öî</button>
    <button id="crystal-ball-btn">üîÆ CONSULT CRYSTAL BALL (costs 2 HP)</button>
  </div>

  <div id="result-screen">
    <div id="result-title"></div>
    <div id="result-message"></div>
    <div id="scorecard-text"></div>
    <button id="copy-btn">üìã COPY SCORECARD</button>
  </div>
  <div id="disclaimer">‚ö† vibecoded ‚Äî use at your own risk ‚ö† ¬∑ v0.7.0</div>

</div>

<script>
// =====================
// GAME DATA
// =====================

const WEAPONS = ['bow', 'sword', 'club'];
const ELEMENTS = ['fire', 'ice', 'electric', 'physical'];

const GOBLIN_FIRST_NAMES = [
  'Glorbo','Fleebo','Snurk','Grix','Moog','Zibble','Krunt','Wobble',
  'Snot','Grubble','Fizz','Dork','Splot','Wumph','Gurgle','Blig',
  'Plonk','Snivel','Twerp','Grob','Muzzy','Flub','Skronk','Vex',
  'Zorp','Quibble','Snaggle','Droob','Chuntle','Flib',
  'Nubble','Grank','Skeebo','Wrix','Plonko','Dribb','Fumble','Gloob',
  'Snorkel','Krubb','Bweep','Twonk','Grimp','Slurp','Blort','Quog',
  'Splonk','Nurgle','Vimble','Zook','Skrag','Mobbe','Dweeb','Grint',
  'Snorb','Flonk','Blibble','Krix','Prunk','Snig','Womp','Glurb',
  'Skibble','Norf','Tweeb','Grobble','Splug','Durk','Fweep','Crungle',
  'Blonk','Nurb','Skwee','Gribb','Wumble','Zonk','Droop','Krimble'
];

// Adjectives that hint at weakness
const HINT_ADJECTIVES = {
  // Weapon hints
  bow:    ['cowardly','skittish','distant','fleeing','dodgy','nimble'],
  sword:  ['armored','shielded','defensive','guarded','plated','scaly'],
  club:   ['bony','hollow','brittle','fragile','cracked','spindly'],
  // Element hints
  fire:   ['flammable','frosty','icy','frozen','chilly','wintry'],  // fire beats ice-themed (ironic) -- actually fire beats fire-weak
  ice:    ['sweating','feverish','volcanic','scorching','ashen','smoldering'],
  electric:['rubbery','grounded','static','sparking','twitching','magnetic'],
  physical:['squishy','doughy','pudgy','bloated','mushy','gelatinous'],
};

// Flavor-only adjectives (no hint)
const FLAVOR_ADJECTIVES = [
  'stinky','smelly','grumpy','sulky','whiny','rude','nasty','soggy',
  'crusty','gloomy','ornery','dim','dopey','surly','greasy','mangy',
  'scruffy','ratty','lumpy','frumpy'
];

// =====================
// SEEDED RNG
// =====================

function seededRng(seed) {
  // Hash the seed first so adjacent dates scatter widely
  let s = seed;
  s = ((s >> 16) ^ s) * 0x45d9f3b | 0;
  s = ((s >> 16) ^ s) * 0x45d9f3b | 0;
  s = (s >> 16) ^ s;
  if (s === 0) s = 1;
  return function() {
    s = (s * 1664525 + 1013904223) & 0xffffffff;
    return (s >>> 0) / 0xffffffff;
  };
}

function getDateSeed() {
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;
  const d = now.getDate();
  return y * 10000 + m * 100 + d;
}

function pick(arr, rng) {
  return arr[Math.floor(rng() * arr.length)];
}

// =====================
// GOBLIN GENERATION
// =====================

function generateGoblin(seed) {
  const rng = seededRng(seed);

  const firstName = pick(GOBLIN_FIRST_NAMES, rng);
  const weakWeapon = pick(WEAPONS, rng);
  const weakElement = pick(ELEMENTS, rng);

  // Decide if adjective hints at weakness (60% chance one axis hints)
  const hintRoll = rng();
  let adjective;
  if (hintRoll < 0.3) {
    // Hint at weapon weakness
    adjective = pick(HINT_ADJECTIVES[weakWeapon], rng);
  } else if (hintRoll < 0.6) {
    // Hint at element weakness
    adjective = pick(HINT_ADJECTIVES[weakElement], rng);
  } else {
    // Pure flavor
    adjective = pick(FLAVOR_ADJECTIVES, rng);
  }

  // Capitalize
  const name = firstName.charAt(0).toUpperCase() + firstName.slice(1);
  const adj = adjective.charAt(0).toUpperCase() + adjective.slice(1);

  return {
    name: `${name} the ${adj}`,
    weakWeapon,
    weakElement,
    maxHp: 5,
    hp: 5
  };
}

// =====================
// GAME STATE
// =====================

const PLAYER_MAX_HP = 5;
const GOBLIN_MAX_HP = 5;

const DAMAGE = {
  veryEffective: 2,
  effective: 1,
  ineffective: 0
};

let state = {
  goblin: null,
  playerHp: PLAYER_MAX_HP,
  turn: 0,
  selectedWeapon: null,
  selectedElement: null,
  crystalUsed: false,
  crystalTurn: -1,
  gameOver: false,
  victory: false,
  log: [],
  attackLog: [] // for scorecard
};

// =====================
// DAILY LOCK (localStorage)
// =====================

const SAVE_KEY = 'slaydle_v1_' + getDateSeed();

function loadSave() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return null;
}

function saveSave(data) {
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
  } catch(e) {}
}

// =====================
// UI HELPERS
// =====================

function formatDate() {
  const now = new Date();
  return now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

function updateHpBars() {
  const goblinPct = Math.max(0, state.goblin.hp / GOBLIN_MAX_HP * 100);
  const playerPct = Math.max(0, state.playerHp / PLAYER_MAX_HP * 100);
  document.getElementById('goblin-hp-bar').style.width = goblinPct + '%';
  document.getElementById('player-hp-bar').style.width = playerPct + '%';
  document.getElementById('goblin-hp-num').textContent = `${Math.max(0,state.goblin.hp)}/${GOBLIN_MAX_HP}`;
  document.getElementById('player-hp-num').textContent = `${Math.max(0,state.playerHp)}/${PLAYER_MAX_HP}`;
}

function addLog(html, classes='') {
  const log = document.getElementById('battle-log');
  // Remove empty placeholder
  const empty = log.querySelector('.log-empty');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = 'log-entry ' + classes;
  div.innerHTML = html;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function updateStrikeBtn() {
  const btn = document.getElementById('strike-btn');
  btn.disabled = !state.selectedWeapon || !state.selectedElement || state.gameOver;
}

// =====================
// COMBAT LOGIC
// =====================

function getEffectiveness(weapon, element) {
  const weaponHit = weapon === state.goblin.weakWeapon;
  const elementHit = element === state.goblin.weakElement;
  if (weaponHit && elementHit) return 'veryEffective';
  if (weaponHit || elementHit) return 'effective';
  return 'ineffective';
}

function doAttack() {
  if (state.gameOver) return;
  const weapon = state.selectedWeapon;
  const element = state.selectedElement;
  state.turn++;

  const effectiveness = getEffectiveness(weapon, element);
  const dmg = DAMAGE[effectiveness];
  state.goblin.hp -= dmg;

  // Log attack
  const weaponEmoji = {bow:'üèπ',sword:'‚öîÔ∏è',club:'ü™ì'}[weapon];
  const elementEmoji = {fire:'üî•',ice:'‚ùÑÔ∏è',electric:'‚ö°',physical:'üí™'}[element];

  addLog(`<span class="log-turn">TURN ${state.turn} ></span> <span class="log-attack">${weaponEmoji} ${weapon.toUpperCase()} + ${elementEmoji} ${element.toUpperCase()}</span>`);

  if (effectiveness === 'veryEffective') {
    addLog(`<span class="log-very-effective">*** VERY EFFECTIVE! (-${dmg} HP) ***</span>`);
  } else if (effectiveness === 'effective') {
    addLog(`<span class="log-effective">~ Effective. (-${dmg} HP)</span>`);
  } else {
    addLog(`<span class="log-ineffective">... Ineffective. (0 damage)</span>`);
  }

  state.attackLog.push({ weapon, element, effectiveness });
  updateHpBars();

  // Check goblin defeat
  if (state.goblin.hp <= 0) {
    state.goblin.hp = 0;
    updateHpBars();
    endGame(true);
    return;
  }

  // Goblin counter-attack
  const goblinDmg = state.turn - 1; // turn 1 = 0 dmg, turn 2 = 1 dmg, etc.
  state.playerHp -= goblinDmg;

  if (goblinDmg === 0) {
    addLog(`<span class="log-goblin-hit">${state.goblin.name.split(' ')[0]} snarls but hesitates!</span>`);
  } else {
    addLog(`<span class="log-goblin-hit">${state.goblin.name.split(' ')[0]} strikes back! (-${goblinDmg} HP)</span>`);
  }

  updateHpBars();

  // Check player defeat
  if (state.playerHp <= 0) {
    state.playerHp = 0;
    updateHpBars();
    endGame(false);
    return;
  }

  // Reset selections
  state.selectedWeapon = null;
  state.selectedElement = null;
  document.querySelectorAll('.attack-btn.selected').forEach(b => b.classList.remove('selected'));
  updateStrikeBtn();
}

// =====================
// CRYSTAL BALL
// =====================

function consultCrystalBall() {
  if (state.crystalUsed || state.gameOver) return;
  if (state.turn < 1) {
    addLog(`<span class="log-hint">üîÆ The crystal ball is cloudy... try attacking first.</span>`);
    return;
  }
  state.crystalUsed = true;
  state.crystalTurn = state.turn;

  // Cost: 2 HP
  state.playerHp = Math.max(0, state.playerHp - 2);
  updateHpBars();

  // Reveal the weak element outright
  const weakEl = state.goblin.weakElement.toUpperCase();
  addLog(`<span class="log-hint">üîÆ The crystal ball blazes! The goblin fears <strong>${weakEl}</strong>!</span>`);
  addLog(`<span class="log-goblin-hit">${state.goblin.name.split(' ')[0]} senses weakness and strikes! (-2 HP)</span>`);

  document.getElementById('crystal-ball-btn').disabled = true;

  if (state.playerHp <= 0) {
    endGame(false);
  }
}

// =====================
// END GAME
// =====================

function buildScorecard(victory) {
  const date = formatDate();
  const effectivenessEmoji = {
    veryEffective: 'üí•',
    effective: '‚úÖ',
    ineffective: '‚ùå'
  };

  let card = `SLAYDLE ‚Äî ${date}\n`;
  card += `${state.goblin.name}\n\n`;

  if (victory) {
    card += `‚öîÔ∏è VICTORY! HP remaining: ${state.playerHp}/${PLAYER_MAX_HP}\n`;
  } else {
    card += `üíÄ DEFEAT! Goblin HP remaining: ${state.goblin.hp}/${GOBLIN_MAX_HP}\n`;
  }

  card += '\n';
  state.attackLog.forEach((atk, i) => {
    card += `Turn ${i+1}: ${effectivenessEmoji[atk.effectiveness]}\n`;
    // Insert crystal ball line after the turn it was used
    if (state.crystalUsed && state.crystalTurn === i) {
      card += `üîÆ\n`;
    }
  });
  // Crystal ball used before any turns
  if (state.crystalUsed && state.crystalTurn === -1) {
    card += `üîÆ\n`;
  }

  card += '\nPlay at: https://niz8.github.io/Slaydle/';
  return card;
}

function endGame(victory) {
  state.gameOver = true;
  state.victory = victory;

  // Disable attack panel
  document.querySelectorAll('.attack-btn, #strike-btn, #crystal-ball-btn').forEach(b => b.disabled = true);

  const resultScreen = document.getElementById('result-screen');
  const resultTitle = document.getElementById('result-title');
  const resultMessage = document.getElementById('result-message');
  const scorecardText = document.getElementById('scorecard-text');

  resultScreen.classList.add('show');

  if (victory) {
    resultScreen.classList.remove('defeat');
    resultTitle.className = 'victory';
    resultTitle.textContent = 'VICTORY!';
    resultMessage.innerHTML = `You defeated <span style="color:#ffff00">${state.goblin.name}</span>!<br>HP remaining: <span style="color:#00ff41">${state.playerHp}/${PLAYER_MAX_HP}</span>`;
  } else {
    resultScreen.classList.add('defeat');
    resultTitle.className = 'defeat';
    resultTitle.textContent = 'DEFEATED...';
    resultMessage.innerHTML = `<span style="color:#ffff00">${state.goblin.name}</span> has bested you.<br>Goblin HP remaining: <span style="color:#ff5555">${state.goblin.hp}/${GOBLIN_MAX_HP}</span>`;
  }

  const scorecard = buildScorecard(victory);
  scorecardText.textContent = scorecard;

  // Save to localStorage
  saveSave({
    gameOver: true,
    victory,
    playerHp: state.playerHp,
    goblinHp: state.goblin.hp,
    goblinName: state.goblin.name,
    attackLog: state.attackLog,
    crystalUsed: state.crystalUsed,
    crystalTurn: state.crystalTurn,
    scorecard
  });
}

// =====================
// SHOW PREVIOUS RESULT
// =====================

function showSavedResult(saved) {
  document.getElementById('goblin-name').textContent = saved.goblinName;

  // Rebuild state enough for display
  state.goblin = generateGoblin(getDateSeed());
  state.goblin.hp = saved.goblinHp;
  state.playerHp = saved.playerHp;
  state.gameOver = true;
  state.attackLog = saved.attackLog || [];
  state.crystalUsed = saved.crystalUsed || false;
  state.crystalTurn = saved.crystalTurn !== undefined ? saved.crystalTurn : -1;

  updateHpBars();

  addLog(`<span class="log-system">[ You already played today. ]</span>`);
  saved.attackLog && saved.attackLog.forEach((atk, i) => {
    const effectivenessEmoji = {veryEffective:'üí•',effective:'‚úÖ',ineffective:'‚ùå'};
    addLog(`Turn ${i+1}: ${atk.weapon.toUpperCase()} + ${atk.element.toUpperCase()} ‚Äî ${effectivenessEmoji[atk.effectiveness]}`);
  });

  document.querySelectorAll('.attack-btn, #strike-btn, #crystal-ball-btn').forEach(b => b.disabled = true);

  const resultScreen = document.getElementById('result-screen');
  const resultTitle = document.getElementById('result-title');
  const resultMessage = document.getElementById('result-message');
  const scorecardText = document.getElementById('scorecard-text');

  resultScreen.classList.add('show');
  if (saved.victory) {
    resultTitle.className = 'victory';
    resultTitle.textContent = 'VICTORY!';
    resultMessage.innerHTML = `You defeated <span style="color:#ffff00">${saved.goblinName}</span>!<br>HP remaining: <span style="color:#00ff41">${saved.playerHp}/${PLAYER_MAX_HP}</span>`;
  } else {
    resultScreen.classList.add('defeat');
    resultTitle.className = 'defeat';
    resultTitle.textContent = 'DEFEATED...';
    resultMessage.innerHTML = `<span style="color:#ffff00">${saved.goblinName}</span> bested you.<br>Goblin HP remaining: <span style="color:#ff5555">${saved.goblinHp}/${GOBLIN_MAX_HP}</span>`;
  }
  scorecardText.textContent = saved.scorecard;
}

// =====================
// INIT
// =====================

function init() {
  // Date display
  document.getElementById('date-display').textContent = formatDate().toUpperCase();

  // Copy button ‚Äî always attach regardless of game state
  document.getElementById('copy-btn').addEventListener('click', () => {
    const text = document.getElementById('scorecard-text').textContent;
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById('copy-btn');
      btn.textContent = '‚úÖ COPIED!';
      setTimeout(() => btn.textContent = 'üìã COPY SCORECARD', 2000);
    });
  });

  // Check for saved game
  const saved = loadSave();
  if (saved && saved.gameOver) {
    showSavedResult(saved);
    return;
  }

  // Generate goblin
  const seed = getDateSeed();
  state.goblin = generateGoblin(seed);
  document.getElementById('goblin-name').textContent = state.goblin.name;

  // Weapon buttons
  document.querySelectorAll('.attack-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (state.gameOver) return;
      const type = btn.dataset.type;
      const value = btn.dataset.value;

      // Deselect others of same type
      document.querySelectorAll(`.attack-btn[data-type="${type}"]`).forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

      if (type === 'weapon') state.selectedWeapon = value;
      else state.selectedElement = value;

      updateStrikeBtn();
    });
  });

  document.getElementById('strike-btn').addEventListener('click', doAttack);
  document.getElementById('crystal-ball-btn').addEventListener('click', consultCrystalBall);
}

init();
</script>

</body>
</html>